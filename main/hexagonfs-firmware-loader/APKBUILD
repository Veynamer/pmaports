pkgname=hexagonfs-firmware-loader
pkgver=1.0.0
pkgrel=1
pkgdesc="Prepare the HexagonFS directory from msm-firmware-loader mounts"
url="https://postmarketos.org/"
subpackages="$pkgname-openrc $pkgname-systemd"
arch="aarch64"
license="MIT"
options="!check"
depends="hexagonrpcd msm-firmware-loader"
_commit="b5e0f3a7082f499646b69839e8997213a18f674f"
source="
	hexagonrpcd.confd
	https://gitlab.postmarketos.org/postmarketOS/hexagonfs-firmware-loader/-/archive/$_commit/hexagonfs-firmware-loader-$_commit.tar.gz
"
builddir="$srcdir/hexagonfs-firmware-loader-$_commit"

package() {
	# Create mountpoint for the HexagonFS files
	mkdir -p "$pkgdir/usr/share/qcom"

	# Install configs for hexagonrpcd to point it to our mountpoint
	install -Dm644 "$srcdir"/hexagonrpcd.confd \
		"$pkgdir"/usr/share/hexagonrpcd/hexagonrpcd-adsp-rootpd.conf
	install -Dm644 "$srcdir"/hexagonrpcd.confd \
		"$pkgdir"/usr/share/hexagonrpcd/hexagonrpcd-adsp-sensorspd.conf
	install -Dm644 "$srcdir"/hexagonrpcd.confd \
		"$pkgdir"/usr/share/hexagonrpcd/hexagonrpcd-sdsp.conf

	install -Dm755 hexagonfs-firmware-loader.sh \
		"$pkgdir/usr/sbin/hexagonfs-firmware-loader.sh"

	cp -r socinfo "$pkgdir/usr/share/hexagonfs-firmware-loader"

	install -Dm755 hexagonfs-firmware-loader.initd \
		"$pkgdir/etc/init.d/hexagonfs-firmware-loader"

	install -Dm644 hexagonfs-firmware-loader.service \
		"$pkgdir/usr/lib/systemd/system/hexagonfs-firmware-loader.service"
}

openrc() {
	install="$subpkgname.post-install"
	default_openrc
}

systemd() {
	install="$subpkgname.post-install $subpkgname.pre-deinstall"
	default_systemd
}

sha512sums="
64c50d1e92cc29b3e8c0e5ee0c14603c5d3b6c9f9671038928cb3093a1276e6004452e55c5f7e3793b72bbc0a7dc48063ed29ba779ece2edea5ac743fa1ec473  hexagonrpcd.confd
37a76521a509a921167c1ab49fc26d02763583edf808b003352c781f4ff583da405c17560f30e95bad65fc52784226df684bbf54641fcb2718a4d56bb784e5d5  hexagonfs-firmware-loader-b5e0f3a7082f499646b69839e8997213a18f674f.tar.gz
"
