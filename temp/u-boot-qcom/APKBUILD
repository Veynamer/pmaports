pkgname=u-boot-qcom
_commit="04584089e12e34aa91ef06aeb91b1550facb0312"
pkgver=0_git20241110
pkgrel=0
pkgdesc="temporary fork for the u-boot bootloader targeting the qcom-next branch"
giturl="https://source.denx.de/u-boot/custodians/u-boot-snapdragon"
url="https://www.denx.de/wiki/U-Boot/"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause WITH eCos-exception-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"
options="!check" # no tests
makedepends="
	bc
	bison
	dtc
	flex
	gnutls-dev
	linux-headers
	mkbootimg-osm0sis
	ncurses-dev
	openssl-dev
	py3-elftools
	py3-setuptools
	python3-dev
	swig
	util-linux-dev
	"
if [ "$CARCH" = "aarch64" ]; then
	makedepends="$makedepends arm-trusted-firmware"
fi
# sm8250-oneplus-{common,kebab} is taken from caleb's patch series to the kernel
# https://patchwork.kernel.org/project/linux-arm-msm/cover/20240630-oneplus8-v2-0-c4a1f8da74f1@postmarketos.org/
source="https://source.denx.de/u-boot/custodians/u-boot-snapdragon/-/archive/$_commit/u-boot-snapdragon-$_commit.tar.gz
	fix-tools-build.patch

	sm8250-oneplus-common.dtsi
	sm8250-oneplus-kebab.dts
	"
builddir="$srcdir/u-boot-snapdragon-$_commit"

_debug_configs="
	sdm845
	sm6115
	sm8250
	"
_devices="
	sdm845-oneplus-enchilada
	sdm845-oneplus-fajita
	sm8250-oneplus-kebab
"

for debug_config in $_debug_configs; do
	for device in $_devices; do
		case "$device" in "$debug_config"-*)
			subpackages="$subpackages $pkgname-debug-$device:_split_debug" ;;
		esac
	done
	subpackages="$subpackages $pkgname-debug-$debug_config:_debug"
done
for device in $_devices; do
	subpackages="$subpackages $pkgname-$device:_split"
done

prepare() {
	default_prepare

	cp "$srcdir"/sm8250-oneplus-*.dts* "$builddir/dts/upstream/src/arm64/qcom"
}

# $1
compile_dir() {
	echo "$builddir/build-$1"
}

# $1: takes release or debug-{sdm845,...}
# $2: additional make config
_build() {
	COMPILE_DIR="$(compile_dir $1)"
	mkdir -p "$COMPILE_DIR"
	make O="$COMPILE_DIR" qcom_defconfig "$2"
	make O="$COMPILE_DIR" u-boot-nodtb.bin
	gzip "$COMPILE_DIR"/u-boot-nodtb.bin
}

build() {
	touch include/config.h
	LC_ALL=C date +'#define U_BOOT_DATE "%b %d %C%y"' > include/timestamp_autogenerated.h
	LC_ALL=C date +'#define U_BOOT_TIME "%T"' >> include/timestamp_autogenerated.h

	_build release

	# TODO: is out-of-tree building possible?
	local dtbs_to_build
	for device in $_devices; do
		dtbs_to_build="src/arm64/qcom/$device.dtb $dtbs_to_build"
	done
	make -C dts/upstream $dtbs_to_build

	local debug_config
	for debug_config in $_debug_configs; do
		_build debug-"$debug_config" "debug-$debug_config.config"
	done
}

package() {
	mkdir -p "$pkgdir/usr/lib/$pkgname"
	install -t "$pkgdir/usr/lib/$pkgname" \
		"$builddir"/build-release/u-boot-nodtb.bin.gz

}

# $1: device
# $2: compile_dir
_device() {
	DEVICE="$1"
	COMPILE_DIR="$(compile_dir $2)"
	DTB="$builddir/dts/upstream/src/arm64/qcom/$DEVICE.dtb"
	BIN_NODTB_PATH="$COMPILE_DIR/u-boot-nodtb.bin.gz"
	BIN_DTB_PATH="$COMPILE_DIR/u-boot-$DEVICE.bin.gz"

	mkdir -p "$subpkgdir/boot"

	cat "$BIN_NODTB_PATH" "$DTB" > "$BIN_DTB_PATH"

	mkbootimg-osm0sis --base 0x0 \
		--kernel_offset 0x8000 \
		--ramdisk_offset 0x01000000 \
		--tags_offset 0x100 \
		--pagesize 4096 \
		--kernel "$BIN_DTB_PATH" \
		-o "$subpkgdir/boot/boot.img"
}

_split() {
	local n="${subpkgname##u-boot-qcom-}"
	provides="u-boot-$n"
	provides_priority=100

	_device "$n" release
}

_split_debug() {
	local n="${subpkgname##u-boot-qcom-debug-}"
	local soc="${n%%-*}"
	provides="u-boot-$n"

	_device "$n" debug-$soc
}

_debug() {
	local n="${subpkgname##u-boot-qcom-debug-}"

	mkdir -p "$subpkgdir/usr/lib/$pkgname/debug"
	install -Dm644 "$builddir/build-debug-$n/u-boot-nodtb.bin.gz" \
		"$subpkgdir/usr/lib/$pkgname/debug/u-boot-nodtb-$n.bin.gz"
}


sha512sums="
a689a951d12423efad79968d810fa4da631ffcd890db83cee91d73acde8089ec1e2593c171727b69a6783ee18349532e79dddf63368ce08106c434c4bbcd9160  u-boot-snapdragon-04584089e12e34aa91ef06aeb91b1550facb0312.tar.gz
1ccba2c96703d82e16126c77c8a88e468ecd704a0a89b015efb7889ca40c6f6a05104269f465cb0d79b824d8e0d1616689d8165c70403a8f52c7d91fa1637623  fix-tools-build.patch
fb03f071217af040f6d52598c00cb06c7e90762a271db8724e58fe3f0a1d21495fd10c2a264256033a9872a1028cdd191e492e2af1af0f2db9e6d857d8caabc0  sm8250-oneplus-common.dtsi
bbc0bd0383aa55f69e7ec18e3476a3d03c999a2dc251c4003c14f02821c182ebd5bf7124c11a0a1056908a0ba86db8cd263aea25ae47734930c127a935933601  sm8250-oneplus-kebab.dts
"
