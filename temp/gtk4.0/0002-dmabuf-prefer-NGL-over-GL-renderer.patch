From 16ef026e1b936237f931e4c257e58d2a4ec3cc2d Mon Sep 17 00:00:00 2001
From: Jane Rachinger <jane400@postmarketos.org>
Date: Sun, 25 May 2025 13:40:05 +0200
Subject: [PATCH 2/5] dmabuf: prefer NGL over GL renderer

Co-authored-by: Henrik Grimler <grimler@postmarketos.org>
---
 gdk/gdkdmabufegl.c | 22 +++++++++++++++-------
 1 file changed, 15 insertions(+), 7 deletions(-)

diff --git a/gdk/gdkdmabufegl.c b/gdk/gdkdmabufegl.c
index a8325ca32b..1827fcbc52 100644
--- a/gdk/gdkdmabufegl.c
+++ b/gdk/gdkdmabufegl.c
@@ -229,6 +229,7 @@ gdk_dmabuf_egl_create_image (GdkDisplay      *display,
 typedef struct _GskRenderer GskRenderer;
 
 extern GskRenderer *   gsk_gl_renderer_new                      (void);
+extern GskRenderer *   gsk_ngl_renderer_new                     (void);
 extern gboolean        gsk_renderer_realize_for_display         (GskRenderer  *renderer,
                                                                  GdkDisplay   *display,
                                                                  GError      **error);
@@ -275,19 +276,26 @@ gdk_dmabuf_egl_init (GdkDisplay *display)
       return;
     }
 
-  renderer = gsk_gl_renderer_new ();
-
+  renderer = gsk_ngl_renderer_new ();
   if (!gsk_renderer_realize_for_display (renderer, display, &error))
     {
-      g_warning ("Failed to realize GL renderer: %s", error->message);
+      g_warning ("Failed to realize NGL renderer: %s", error->message);
       g_error_free (error);
       g_object_unref (renderer);
-      if (previous)
+
+      renderer = gsk_gl_renderer_new ();
+      if (!gsk_renderer_realize_for_display (renderer, display, &error))
         {
-          gdk_gl_context_make_current (previous);
-          g_object_unref (previous);
+          g_warning ("Failed to realize deprecated GL renderer: %s", error->message);
+          g_error_free (error);
+          g_object_unref (renderer);
+          if (previous)
+            {
+              gdk_gl_context_make_current (previous);
+              g_object_unref (previous);
+            }
+          return;
         }
-      return;
     }
 
   if (previous)
-- 
2.49.0

