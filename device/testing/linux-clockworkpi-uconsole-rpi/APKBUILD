# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/bcm2711_defconfig
# Maintainer: Federico Amedeo Izzo <federico@izzo.pro>
pkgname=linux-clockworkpi-uconsole-rpi
pkgver=6.12.32
pkgrel=0
pkgdesc="Clockwork Tech ClockworkPi uConsole Rapsberry Pi kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="clockworkpi-uconsole-rpi"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
depends="linux-firmware-brcm"
provides="linux-clockworkpi-uconsole-cm4=$pkgver-r$pkgrel"
makedepends="
	bash
	bc
	bison
	devicepkg-dev
	flex
	installkernel
	linux-firmware
	linux-headers
	openssl-dev
	perl
	xz
"

# Source
_repository="linux"
# can refer to https://github.com/archlinuxarm/PKGBUILDs/blob/master/core/linux-rpi/PKGBUILD for commit
_commit="cde997ebd50e5fecfa7a2676578f27deb10efd34"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/raspberrypi/$_repository/archive/$_commit.tar.gz
	$_config
	postmarketos-config.patch
	0001-video-backlight-add-OCP8178-backlight-driver.patch
	0002-gpu-drm-add-CWU50-and-CWD686-panels.patch
	0003-power-supply-add-axp20x-drivers.patch
	0004-arm64-configs-update-bcm2712-bcm2711-defconfig.patch
	0005-arm-boot-overlays-add-uconsole-overlays.patch
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	default_prepare
	cp "$srcdir/config-$_flavor.$CARCH" .config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" "$_flavor"

	local _install_dtbs_path="$pkgdir"/boot

	mkdir -p "$pkgdir"/boot
	make modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_PATH="$pkgdir"/boot \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_DTBS_PATH="$_install_dtbs_path"
	rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

	mv -f "$_install_dtbs_path"/broadcom/*.dtb \
		"$_install_dtbs_path"
	rmdir "$_install_dtbs_path"/broadcom
}

sha512sums="
d9709b016ae66753ad1d74af85262320a2dea563e9f93b457c800931be5b71258a8e8c00a58a37bd8679103b9967bb2b5e4b87d673aaeb1db818e1e7a8dec66a  linux-clockworkpi-uconsole-rpi-cde997ebd50e5fecfa7a2676578f27deb10efd34.tar.gz
ee35963f26d4f7d14119db2f0c53a760f64dab157209639cacd07f6dc57e6e4d17d22970cdef8b692a2834c92fe5108f058a72355637edfa407f41317603bd4c  config-clockworkpi-uconsole-rpi.aarch64
0f7150a254dc9b3445ac51669ee37acd7960c33537757d1df88171fc9e821c31c92e585145b4659b0ebd1d981a51e696763f49c4b0cadbc36a076305ffadf37c  postmarketos-config.patch
f984d9150424470e34570e5c6ecc938ce5af214e4bfbd56c57425e4f4dc563952086392a50906a51298a6480060ff16f4a5487fc1f6ff353653148b52808e91e  0001-video-backlight-add-OCP8178-backlight-driver.patch
538a5c2bca24e757163c386ea7b63b07453c9c60b2168ec17589bf39f1fd7249268b17c7fc857e73965fd18d07a8a45c75a58b146a19791d53f0e0efad61157c  0002-gpu-drm-add-CWU50-and-CWD686-panels.patch
25c75f3e1e702997e3ff6ac5f6511529cd53aaf92ec5c626be2f23c9e479ba67a3a9d6638ecc8eb6735fa996f033a6d02fc85cbca98acb10de40e528cd107cc9  0003-power-supply-add-axp20x-drivers.patch
48931da5ef0468a988cabdd3b1580fefccf9a1420fd5d664fb48c3201539d47f1d707ac16a88f038f52c9a183d1924e49eaa1d339028c51195944fa88829bee3  0004-arm64-configs-update-bcm2712-bcm2711-defconfig.patch
c705d756c331a8dc6287337b7e55f15886920010c4277549e41ca663bb5421cabab492604d167f63816dfb3883181c746b69a57aaf56761bebe4e2acd6120c69  0005-arm-boot-overlays-add-uconsole-overlays.patch
"
